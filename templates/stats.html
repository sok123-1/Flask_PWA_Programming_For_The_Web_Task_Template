<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Habitly — Stats</title>
  <style>
    :root{
      --bg-grad-1: #fbf9f6;
      --bg-grad-2: #f0faf8;
      --primary: #0d9488;
      --primary-600: #087f76;
      --wood: #8b5e3c;
      --muted: #7a6b5a;
      --text: #22323a;
      --card-radius:14px;
      --glass: rgba(255,255,255,0.95);
      --pad:18px;
      --ease: cubic-bezier(.2,.9,.2,1);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial;color:var(--text);background:linear-gradient(180deg,var(--bg-grad-1),var(--bg-grad-2));-webkit-font-smoothing:antialiased;padding:28px}
    .topbar{max-width:1180px;margin:0 auto 22px;display:flex;justify-content:space-between;align-items:center;gap:12px}
    .logo-mark{width:44px;height:44;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--wood));color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
    .page{max-width:1180px;margin:0 auto;display:grid;grid-template-columns:1fr 360px;gap:22px}
    .panel{background:var(--glass);padding:var(--pad);border-radius:var(--card-radius);box-shadow:0 12px 40px rgba(17,24,19,0.06);border:1px solid rgba(20,60,55,0.04)}
    .pill{padding:8px 12px;border-radius:999px;background:linear-gradient(90deg, rgba(13,148,136,0.07), rgba(139,94,60,0.03));color:var(--primary);font-weight:500;font-size:13px;text-decoration:none}
    .pill.active{ background: linear-gradient(90deg,var(--primary),var(--primary-600)); color: #fff; box-shadow: 0 8px 20px rgba(13,148,136,0.12); }
    h1{margin:0 0 6px 0;font-size:20px}
    .muted{color:var(--muted);font-size:13px}
    .stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:14px}
    .stat{padding:12px;border-radius:10px;background:linear-gradient(180deg,#fff,#f7fbfa);text-align:center}
    .stat .k{font-weight:700;color:var(--primary);font-size:20px}
    .leaderboard{margin-top:16px}
    .leaderboard-item{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.9),#fbfbfb);margin-bottom:8px;border:1px solid rgba(20,60,55,0.03)}
    .leader-left{display:flex;gap:12px;align-items:center;min-width:0}
    .avatar{width:44px;height:44;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--wood));color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
    .lbl{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .meta{color:var(--muted);font-size:12px}
    .chart{margin-top:12px;padding:12px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbfbfb);border:1px solid rgba(20,60,55,0.03)}
    .bar-row{display:flex;align-items:center;gap:8px;margin-bottom:8px}
    .bar-label{width:72px;font-size:13px;color:var(--muted)}
    .bar-track{flex:1;height:12px;background:rgba(20,60,55,0.06);border-radius:8px;overflow:hidden}
    .bar-fill{height:100%;background:linear-gradient(90deg,var(--primary),var(--primary-600));border-radius:8px}
    .empty{padding:20px;text-align:center;color:var(--muted)}
    .back{display:inline-block;margin-right:12px;padding:8px 12px;border-radius:10px;background:transparent;border:1px solid rgba(20,60,55,0.04);cursor:pointer;text-decoration:none;color:inherit}
    @media (max-width:960px){ .page{grid-template-columns:1fr} .stats-grid{grid-template-columns:repeat(2,1fr)} }
  </style>
</head>
<body>
  <div class="topbar">
    <div style="display:flex;align-items:center;gap:12px">
      <a href="{{ url_for('dashboard') }}" class="back">← Dashboard</a>
      <div class="logo-mark">H</div>
      <div>
        <div style="font-weight:700">Habitly — Stats</div>
        <div class="muted">Leaderboards & wellbeing summary</div>
      </div>
    </div>

    <div style="display:flex;align-items:center;gap:10px">
      <a id="nav-dashboard" href="{{ url_for('dashboard') }}" class="pill">Dashboard</a>
      <a id="nav-stats" href="{{ url_for('stats') }}" class="pill active">Stats</a>
      <a id="nav-diary" href="/diary" class="pill" style="text-decoration:none">Diary</a>
    </div>
  </div>

  <main class="page" role="main">
    <section>
      <div class="panel">
        <h1>Overview</h1>
        <div class="muted">Snapshot for habits and recent wellbeing check-ins</div>

        <div class="stats-grid" id="overview">
          <div class="stat">
            <div class="k" id="tot">0</div>
            <div class="muted">Total habits</div>
          </div>
          <div class="stat">
            <div class="k" id="done">0</div>
            <div class="muted">Completed today</div>
          </div>
          <div class="stat">
            <div class="k" id="long">0</div>
            <div class="muted">Longest streak</div>
          </div>
        </div>

        <div class="leaderboard" aria-live="polite">
          <h2 style="margin:18px 0 10px 0">Leaderboard — Longest streaks</h2>
          <div id="leaderboard-list"></div>
        </div>

        <div style="margin-top:18px">
          <h2 style="margin:0 0 10px 0">Wellbeing — last 7 days</h2>
          <div class="chart" id="mood-chart">
            <div id="mood-empty" class="empty">No diary entries yet.</div>
            <div id="mood-bars" style="display:none"></div>
          </div>
        </div>
      </div>
    </section>

    <aside>
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Details</div>
          <button id="refresh" class="back" type="button">Refresh</button>
        </div>

        <div style="margin-top:12px">
          <div style="font-weight:700">Top habit</div>
          <div id="top-habit" class="muted" style="margin-top:8px">—</div>
        </div>
      </div>
    </aside>
  </main>

  <script>
    (function(){
      const HAB_KEY = 'habitly_v4';
      const DIARY_KEY = 'habitly_diary_v1';

      function loadHab(){ try{ return JSON.parse(localStorage.getItem(HAB_KEY) || '{"groups":[],"habits":[]}'); }catch(e){ return {groups:[],habits:[]}; } }
      function loadDiary(){ try{ return JSON.parse(localStorage.getItem(DIARY_KEY) || '[]'); }catch(e){ return []; } }

      function qs(id){ return document.getElementById(id); }

      function renderOverview(){
        const state = loadHab();
        const habits = state.habits || [];
        qs('tot').textContent = habits.length;
        qs('done').textContent = habits.filter(h=>h.doneToday).length;
        qs('long').textContent = habits.reduce((m,h)=> Math.max(m, h.longestStreak || 0), 0);
      }

      function renderLeaderboard(){
        const state = loadHab();
        const habits = (state.habits || []).slice();
        const container = qs('leaderboard-list');
        container.innerHTML = '';
        if (!habits.length){
          container.innerHTML = '<div class="empty">No habits yet — add some on the dashboard.</div>'; return;
        }
        const ordered = habits.sort((a,b)=> (b.longestStreak||0) - (a.longestStreak||0) || ((b.currentStreak||0) - (a.currentStreak||0)));
        ordered.slice(0,12).forEach((h,idx)=>{
          const el = document.createElement('div'); el.className = 'leaderboard-item';
          const left = document.createElement('div'); left.className='leader-left';
          const avatar = document.createElement('div'); avatar.className='avatar'; avatar.textContent = (h.text||'')[0] ? (h.text||'')[0].toUpperCase() : 'H';
          const info = document.createElement('div'); info.style.minWidth='0';
          const lbl = document.createElement('div'); lbl.className='lbl'; lbl.textContent = h.text || 'Untitled';
          const meta = document.createElement('div'); meta.className='meta'; meta.textContent = `Current ${h.currentStreak||0} • Longest ${h.longestStreak||0}`;
          info.appendChild(lbl); info.appendChild(meta);
          left.appendChild(avatar); left.appendChild(info);

          const right = document.createElement('div'); right.style.textAlign='right';
          const pos = document.createElement('div'); pos.style.fontWeight='700'; pos.style.color='var(--primary)'; pos.textContent = h.longestStreak || 0;
          const rank = document.createElement('div'); rank.className='muted'; rank.style.fontSize='12px'; rank.textContent = `#${idx+1}`;
          right.appendChild(pos); right.appendChild(rank);

          el.appendChild(left); el.appendChild(right);
          container.appendChild(el);
        });
      }

      function renderMoodChart(){
        const entries = loadDiary().slice().sort((a,b)=> b.date.localeCompare(a.date)).slice(0,14);
        const barsWrap = qs('mood-bars');
        const empty = qs('mood-empty');
        if (!entries.length){ empty.style.display='block'; barsWrap.style.display='none'; return; }
        empty.style.display='none'; barsWrap.style.display='block';
        // count last 7 days
        const last7 = entries.slice(0,7);
        const counts = {};
        last7.forEach(e=> counts[e.mood] = (counts[e.mood]||0) + 1);
        const total = last7.length || 1;
        barsWrap.innerHTML = '';
        const orderedMoods = Object.keys(counts).sort((a,b)=> counts[b]-counts[a]);
        orderedMoods.forEach(m=>{
          const row = document.createElement('div'); row.className='bar-row';
          const lbl = document.createElement('div'); lbl.className='bar-label'; lbl.textContent = m;
          const track = document.createElement('div'); track.className='bar-track';
          const fill = document.createElement('div'); fill.className='bar-fill'; fill.style.width = Math.round((counts[m]/total)*100) + '%';
          track.appendChild(fill);
          const meta = document.createElement('div'); meta.className='muted'; meta.style.width='48px'; meta.style.textAlign='right'; meta.textContent = counts[m];
          row.appendChild(lbl); row.appendChild(track); row.appendChild(meta);
          barsWrap.appendChild(row);
        });
      }

      function renderDetails(){
        const state = loadHab();
        const habits = state.habits || [];
        const top = habits.slice().sort((a,b)=> (b.longestStreak||0) - (a.longestStreak||0))[0];
        qs('top-habit').textContent = top ? `${top.text} — ${top.longestStreak||0} 🔥` : '—';
      }

      function renderAll(){
        renderOverview();
        renderLeaderboard();
        renderMoodChart();
        renderDetails();
      }

      // realtime / sync
      window.addEventListener('storage', (e)=>{ if (e.key === HAB_KEY || e.key === DIARY_KEY) renderAll(); });
      document.getElementById('refresh').addEventListener('click', ()=> renderAll());
      // small poll to be responsive to changes from other scripts
      let _last = localStorage.getItem(HAB_KEY) + '|' + localStorage.getItem(DIARY_KEY);
      setInterval(()=>{
        const now = (localStorage.getItem(HAB_KEY)||'') + '|' + (localStorage.getItem(DIARY_KEY)||'');
        if (now !== _last){ _last = now; renderAll(); }
      }, 1200);

      // initial
      renderAll();
    })();
  </script>
</body>
</html>