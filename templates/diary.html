<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Habitly â€” Wellbeing diary</title>
  <style>
    :root{
      --bg-grad-1: #fbf9f6;
      --bg-grad-2: #f0faf8;
      --primary: #0d9488;
      --primary-600: #087f76;
      --wood: #8b5e3c;
      --muted: #7a6b5a;
      --text: #22323a;
      --card-radius:14px;
      --glass: rgba(255,255,255,0.9);
      --pad:18px;
      --ease: cubic-bezier(.2,.9,.2,1);
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:Inter,system-ui,Arial;color:var(--text);
      background: linear-gradient(180deg,var(--bg-grad-1),var(--bg-grad-2));
      padding:28px;-webkit-font-smoothing:antialiased;
    }
    .topbar{max-width:1180px;margin:0 auto 22px;display:flex;justify-content:space-between;align-items:center;gap:12px}
    .logo-mark{width:44px;height:44;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--wood));color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
    .muted{color:var(--muted);font-size:13px}
    .page{max-width:1180px;margin:0 auto;display:grid;grid-template-columns:1fr 360px;gap:22px}
    .panel{background:var(--glass);padding:var(--pad);border-radius:var(--card-radius);box-shadow:0 12px 40px rgba(17,24,19,0.06);border:1px solid rgba(20,60,55,0.04)}
    .heading-row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .btn{padding:10px 14px;border-radius:12px;border:0;background:linear-gradient(90deg,var(--primary),var(--primary-600));color:white;font-weight:600;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(20,60,55,0.06);color:var(--text)}
    .diary-form{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .row{display:flex;gap:10px;align-items:center}
    input[type="date"], select, textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(20,60,55,0.06);background:white;font-size:14px}
    textarea{min-height:96px;resize:vertical}
    .entries{display:flex;flex-direction:column;gap:12px;margin-top:14px}
    .entry{padding:12px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.95),#fbfbfb);border:1px solid rgba(20,60,55,0.03);display:flex;justify-content:space-between;align-items:flex-start}
    .entry-left{min-width:0}
    .entry-date{font-weight:700;color:var(--wood)}
    .entry-meta{color:var(--muted);font-size:13px;margin-top:6px}
    .entry-actions{display:flex;gap:8px}
    .icon-btn{background:transparent;border:0;padding:8px;border-radius:8px;cursor:pointer;color:var(--muted)}
    .icon-btn:hover{background:rgba(13,148,136,0.06);color:var(--primary)}
    @media (max-width:960px){ .page{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="topbar">
    <div style="display:flex;align-items:center;gap:12px">
      <a href="{{ url_for('dashboard') }}" class="btn ghost" style="padding:8px 10px;border-radius:10px;text-decoration:none;color:inherit">â† Dashboard</a>
      <div class="logo-mark">H</div>
      <div>
        <div style="font-weight:700">Wellbeing diary</div>
        <div class="muted">Daily mood & check-ins</div>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:8px">
      <a href="{{ url_for('stats') }}" class="btn ghost" style="text-decoration:none;color:inherit">Stats</a>
    </div>
  </div>

  <main class="page" role="main">
    <section>
      <div class="panel">
        <div class="heading-row">
          <div>
            <div style="font-size:18px;font-weight:700">Today's check-in</div>
            <div class="muted" style="margin-top:6px">Record how you're feeling â€” small notes help.</div>
          </div>
          <div>
            <button id="open-add" class="btn">New check-in</button>
          </div>
        </div>

        <div id="inline-form" class="diary-form" aria-hidden="false">
          <div class="row">
            <input id="entry-date" type="date" />
            <select id="entry-mood" aria-label="Mood">
              <option value="ğŸ˜Š">ğŸ˜Š Good</option>
              <option value="ğŸ™‚">ğŸ™‚ Okay</option>
              <option value="ğŸ˜">ğŸ˜ Neutral</option>
              <option value="ğŸ˜”">ğŸ˜” Low</option>
              <option value="ğŸ˜¡">ğŸ˜¡ Stressed</option>
            </select>
          </div>
          <div>
            <textarea id="entry-notes" placeholder="Short note (how was your day, what went well?)"></textarea>
          </div>
          <div style="display:flex;justify-content:flex-end;gap:8px">
            <button id="save-entry" class="btn">Save</button>
            <button id="clear-entry" class="btn ghost">Clear</button>
          </div>
        </div>

        <div style="margin-top:14px">
          <div style="font-weight:600;margin-bottom:8px">Recent entries</div>
          <div id="entries" class="entries" aria-live="polite">
            <div class="muted">No check-ins yet â€” add your first one above.</div>
          </div>
        </div>
      </div>
    </section>

    <aside>
      <div class="panel">
        <div style="font-weight:700">How to use</div>
        <div class="muted" style="margin-top:8px">
          - Make a short daily note and choose a mood.<br/>
          - You can edit or delete any entry.<br/>
        </div>

        <div style="margin-top:12px">
          <div style="font-weight:700">Quick stats</div>
          <div id="quick-stats" style="margin-top:8px" class="muted">â€”</div>
        </div>
      </div>
    </aside>
  </main>

  <dialog id="editDialog" class="modal" aria-modal="true" role="dialog">
    <div style="padding:18px;background:var(--glass);border-radius:12px;max-width:520px">
      <div style="font-weight:700" id="edit-title">Edit check-in</div>
      <div style="margin-top:8px" class="muted">Change date, mood or notes.</div>
      <div style="margin-top:12px;display:flex;flex-direction:column;gap:10px">
        <input id="edit-date" type="date" />
        <select id="edit-mood">
          <option value="ğŸ˜Š">ğŸ˜Š Good</option>
          <option value="ğŸ™‚">ğŸ™‚ Okay</option>
          <option value="ğŸ˜">ğŸ˜ Neutral</option>
          <option value="ğŸ˜”">ğŸ˜” Low</option>
          <option value="ğŸ˜¡">ğŸ˜¡ Stressed</option>
        </select>
        <textarea id="edit-notes"></textarea>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button id="edit-cancel" class="btn ghost">Cancel</button>
        <button id="edit-save" class="btn">Save</button>
      </div>
    </div>
  </dialog>

  <script>
    (function(){
      const KEY = 'habitly_diary_v1';
      function load(){ try{ return JSON.parse(localStorage.getItem(KEY) || '[]'); }catch(e){ return []; } }
      function save(data){ localStorage.setItem(KEY, JSON.stringify(data)); }

      const entryDateEl = document.getElementById('entry-date');
      const entryMoodEl = document.getElementById('entry-mood');
      const entryNotesEl = document.getElementById('entry-notes');
      const saveEntryBtn = document.getElementById('save-entry');
      const clearEntryBtn = document.getElementById('clear-entry');
      const entriesEl = document.getElementById('entries');
      const openAddBtn = document.getElementById('open-add');
      const quickStatsEl = document.getElementById('quick-stats');

      const editDialog = document.getElementById('editDialog');
      const editDate = document.getElementById('edit-date');
      const editMood = document.getElementById('edit-mood');
      const editNotes = document.getElementById('edit-notes');
      const editSave = document.getElementById('edit-save');
      const editCancel = document.getElementById('edit-cancel');

      let entries = load();
      let editingId = null;

      function todayStr(){ return new Date().toISOString().slice(0,10); }
      function id(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,6); }

      function setDefaults(){
        entryDateEl.value = todayStr();
        entryMoodEl.value = 'ğŸ˜Š';
        entryNotesEl.value = '';
      }
      setDefaults();

      function render(){
        entries = load();
        entries.sort((a,b)=> b.date.localeCompare(a.date));
        entriesEl.innerHTML = '';
        if (!entries.length){
          entriesEl.innerHTML = '<div class="muted">No check-ins yet â€” add your first one above.</div>';
        } else {
          entries.forEach(e=>{
            const row = document.createElement('div'); row.className = 'entry';
            const left = document.createElement('div'); left.className = 'entry-left';
            const date = document.createElement('div'); date.className='entry-date'; date.textContent = e.date + ' Â· ' + (e.mood||'');
            const notes = document.createElement('div'); notes.className='entry-meta'; notes.textContent = e.notes || '';
            left.appendChild(date); left.appendChild(notes);

            const actions = document.createElement('div'); actions.className='entry-actions';
            const editBtn = document.createElement('button'); editBtn.className='icon-btn'; editBtn.innerHTML = 'âœ'; editBtn.title='Edit';
            editBtn.addEventListener('click', ()=> openEdit(e.id));
            const delBtn = document.createElement('button'); delBtn.className='icon-btn'; delBtn.innerHTML = 'ğŸ—‘ï¸'; delBtn.title='Delete';
            delBtn.addEventListener('click', ()=> {
              if (!confirm('Delete check-in for '+e.date+'?')) return;
              entries = entries.filter(x=>x.id!==e.id); save(entries); render();
            });

            actions.appendChild(editBtn); actions.appendChild(delBtn);
            row.appendChild(left); row.appendChild(actions);
            entriesEl.appendChild(row);
          });
        }
        renderQuickStats();
      }

      function renderQuickStats(){
        if (!entries.length){ quickStatsEl.textContent = 'â€”'; return; }
        const last7 = entries.slice().sort((a,b)=> b.date.localeCompare(a.date)).slice(0,7);
        const moodCounts = last7.reduce((acc,e)=>{ acc[e.mood] = (acc[e.mood]||0)+1; return acc }, {});
        const summary = Object.keys(moodCounts).map(k=> `${k} ${moodCounts[k]}` ).join(' Â· ');
        quickStatsEl.textContent = `Last 7 days: ${summary || 'â€”'}`;
      }

      function upsertEntry(date, mood, notes){
        entries = load();
        const existing = entries.find(e=>e.date === date);
        if (existing){
          existing.mood = mood; existing.notes = notes; existing.updatedAt = Date.now();
        } else {
          entries.push({ id: id(), date, mood, notes, createdAt: Date.now() });
        }
        save(entries); render();
      }

      saveEntryBtn.addEventListener('click', ()=>{
        const date = entryDateEl.value || todayStr();
        const mood = entryMoodEl.value || 'ğŸ˜Š';
        const notes = entryNotesEl.value.trim();
        upsertEntry(date, mood, notes);
        setDefaults();
      });

      clearEntryBtn.addEventListener('click', ()=> setDefaults());

      openAddBtn.addEventListener('click', ()=> { entryNotesEl.focus(); });

      function openEdit(id){
        const e = entries.find(x=>x.id===id); if(!e) return;
        editingId = id;
        editDate.value = e.date;
        editMood.value = e.mood || 'ğŸ˜Š';
        editNotes.value = e.notes || '';
        try{ editDialog.showModal(); }catch(err){ editDialog.open = true; }
      }
      editCancel.addEventListener('click', ()=> { try{ editDialog.close(); }catch(e){ editDialog.open = false } });

      editSave.addEventListener('click', ()=>{
        if (!editingId) return;
        const e = entries.find(x=>x.id===editingId); if(!e) return;
        e.date = editDate.value || todayStr();
        e.mood = editMood.value || 'ğŸ˜Š';
        e.notes = editNotes.value.trim();
        e.updatedAt = Date.now();
        save(entries);
        try{ editDialog.close(); }catch(err){ editDialog.open = false; }
        render();
      });

      window.addEventListener('storage', (ev)=>{ if (ev.key === KEY) render(); });
      let lastRaw = localStorage.getItem(KEY);
      setInterval(()=>{ const nowRaw = localStorage.getItem(KEY); if (nowRaw !== lastRaw){ lastRaw = nowRaw; render(); } }, 1500);

      render();
    })();
  </script>
</body>
</html>